---
import { getLocalizedPath } from '../i18n/utils';

const languages = [
  { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'tr', name: 'TÃ¼rkÃ§e', flag: 'ðŸ‡¹ðŸ‡·' },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' }
];

const currentLocale = Astro.currentLocale || 'en';
const currentPath = Astro.url.pathname;
---

<div class="relative inline-block text-left">
  <button
    id="language-button"
    type="button"
    class="inline-flex items-center gap-2 rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm font-medium text-white/90 backdrop-blur transition hover:bg-white/10"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span>{languages.find(l => l.code === currentLocale)?.flag}</span>
    <span class="hidden sm:inline">{languages.find(l => l.code === currentLocale)?.name}</span>
    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
    </svg>
  </button>

  <div
    id="language-menu"
    class="absolute right-0 z-50 mt-2 w-48 origin-top-right translate-y-2 scale-95 rounded-lg border border-white/10 bg-neutral-950/95 opacity-0 shadow-lg backdrop-blur-lg transition duration-200 ease-out pointer-events-none"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="language-button"
  >
    <div class="p-1" role="none">
      {languages.map((lang) => {
        // Get the base path without locale prefix
        const basePath = currentPath.replace(/^\/(tr|zh)/, '') || '/';
        // Get the localized path for this language
        const localizedPath = getLocalizedPath(basePath, lang.code);
        
        return (
          <a
            href={localizedPath}
            class={`flex items-center gap-3 rounded-md px-3 py-2 text-sm transition ${
              currentLocale === lang.code 
                ? 'bg-lotus-600 text-white' 
                : 'text-white/80 hover:bg-white/10 hover:text-white'
            }`}
            role="menuitem"
          >
            <span class="text-lg">{lang.flag}</span>
            <span>{lang.name}</span>
          </a>
        );
      })}
    </div>
  </div>
</div>

<script>
  const button = document.getElementById('language-button');
  const menu = document.getElementById('language-menu');

  function openMenu() {
    menu?.classList.remove('opacity-0', 'scale-95', 'translate-y-2', 'pointer-events-none');
    menu?.classList.add('opacity-100', 'scale-100', 'translate-y-0');
    button?.setAttribute('aria-expanded', 'true');
  }

  function closeMenu() {
    menu?.classList.add('opacity-0', 'scale-95', 'translate-y-2', 'pointer-events-none');
    menu?.classList.remove('opacity-100', 'scale-100', 'translate-y-0');
    button?.setAttribute('aria-expanded', 'false');
  }

  button?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = button.getAttribute('aria-expanded') === 'true';
    isOpen ? closeMenu() : openMenu();
  });

  document.addEventListener('click', (e) => {
    if (!menu?.contains(e.target as Node) && !button?.contains(e.target as Node)) {
      closeMenu();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeMenu();
  });
</script>
